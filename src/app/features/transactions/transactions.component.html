<ion-content [fullscreen]="true" class="transactions-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="transactions-container">
    <div class="header-simple">
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/tabs/dashboard" class="custom-back-btn" text="" icon="chevron-back-outline"></ion-back-button>
      </ion-buttons>
      <h2>All Transactions</h2>
      <div style="width: 48px;"></div>
    </div>

    @if (!isLoaded()) {
      <div class="skeleton-wrapper">
        <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 12px; border-radius: 12px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 12px; border-radius: 12px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 12px; border-radius: 12px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 60px; margin-bottom: 12px; border-radius: 12px;"></ion-skeleton-text>
      </div>
    } @else {
      @if (topMerchants().length > 0) {
        <div class="top-merchants-section fade-in">
          <div class="section-header-small">
            <h3>Top Merchants</h3>
          </div>
          <div class="merchants-scroll">
            @for (merchant of topMerchants(); track merchant.name) {
              <div class="merchant-chip glass-card">
                <div class="mc-icon">
                  <ion-icon name="storefront-outline"></ion-icon>
                </div>
                <div class="mc-details">
                  <span class="mc-name">{{ merchant.name }}</span>
                  <span class="mc-amount">{{ merchant.total | currency }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (detectedBanks().length > 0) {
        <div class="detected-banks-section fade-in">
          <div class="section-header-small">
            <h3>Auto-detected Bank Accounts</h3>
            <span class="badge">{{ detectedBanks().length }} New</span>
          </div>
          <p class="section-desc">We found these banks from your SMS. Would you like to add them?</p>
          <div class="banks-scroll">
            @for (bank of detectedBanks(); track bank.name) {
              <div class="bank-chip glass-card">
                <div class="bank-info" style="display: flex; align-items: center; gap: 12px;">
                  <div class="bank-icon" style="flex-shrink: 0; align-self: center;">
                    <ion-icon name="business-outline"></ion-icon>
                  </div>
                  <div class="bank-text" style="display: flex; flex-direction: column;">
                    <span class="bank-name" style="font-weight: 600; font-size: 14px;">{{ bank.name }}</span>
                    <span class="bank-meta" style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                      @if (bank.accIdentifier) { xx{{ bank.accIdentifier.slice(-4) }} • } 
                      {{ bank.count }} txns 
                      @if (bank.totalAmount > 0) { • {{ bank.totalAmount | currency }} }
                    </span>
                  </div>
                </div>
                <button class="add-bank-btn" (click)="addDetectedBank(bank.name)" style="margin-left: auto;">
                  Add <ion-icon name="add-outline"></ion-icon>
                </button>
              </div>
            }
          </div>
        </div>
      }

      <div class="transactions-list">
        @for (tx of allTransactions(); track tx.id) {
          <div class="tx-card-vertical" (click)="editTransaction(tx)">
            <div class="tx-card-icon" [ngClass]="getCategoryColorClass(tx.categoryId)">
              <ion-icon [name]="getCategoryIcon(tx.categoryId)"></ion-icon>
            </div>
            
            <div class="tx-card-details">
              <span class="tx-name">{{ tx.merchantName || tx.description || getCategoryName(tx.categoryId) }}</span>
              <span class="tx-date">{{ formatRelativeDetailed(tx.date) }}</span>
            </div>

            <div class="tx-card-right">
              <span class="tx-amount">{{ tx.amount | currency }}</span>
              <div class="tx-type-icon" [ngClass]="getTxTypeClass(tx)">
                <ion-icon [name]="getTxTypeIcon(tx)"></ion-icon>
              </div>
            </div>
          </div>
        } @empty {
          <div class="empty-state">
             <div class="empty-icon"><ion-icon name="receipt-outline"></ion-icon></div>
             <h3>No transactions</h3>
             <p>You haven't added any transactions yet.</p>
          </div>
        }
      </div>
    }
  </div>
</ion-content>
