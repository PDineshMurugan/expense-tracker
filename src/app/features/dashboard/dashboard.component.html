<ion-content [fullscreen]="true" class="dashboard-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="dashboard-container">
    <!-- Header -->
    <header class="app-header">
      <div class="user-greeting">
        <div class="logo-container">
          <div class="logo-mark">
            <div class="logo-inner"></div>
          </div>
        </div>
        <h1>Hi</h1>
      </div>
      <button class="icon-btn" routerLink="/tabs/transactions">
        <ion-icon name="search-outline"></ion-icon>
      </button>
    </header>

    @if (!expenseService.isLoaded()) {
      <div class="skeleton-wrapper">
        <ion-skeleton-text animated style="width: 200px; height: 200px; border-radius: 50%; margin: 0 auto;"></ion-skeleton-text>
      </div>
    } @else {
      <section class="balance-section">
        <p class="month-label">Spent in <strong>{{ currentMonthName() }}</strong></p>
        <div class="balance-circle">
          <div class="circle-content">
            <ion-icon name="arrow-up-outline" class="trend-icon-up"></ion-icon>
            <h2 class="total-spent">{{ expenseService.monthlyTotal() | currency }}</h2>
          </div>
          <svg class="progress-ring" viewBox="0 0 120 120">
            <circle class="ring-track" cx="60" cy="60" r="54"></circle>
            <circle class="ring-fill" cx="60" cy="60" r="54"
                    [style.stroke-dasharray]="circleCircumference"
                    [style.stroke-dashoffset]="circleOffset(expenseService.monthlyTotal())"></circle>
          </svg>
        </div>
        <div class="balance-stats">
          <div class="stat-item actionable" routerLink="/tabs/settings">
            <div class="shield-icon"><div class="dot"></div></div>
            <span class="stat-label action-text">Set monthly<br>budget</span>
          </div>
        </div>
      </section>

      <section class="action-pills">
        <button class="pill-btn" routerLink="/tabs/reports">
          <div class="icon-box bar-chart">
            <div class="bar bar-1"></div><div class="bar bar-2"></div><div class="bar bar-3"></div>
          </div>
          <span>Trends</span>
        </button>
        <button class="pill-btn" routerLink="/tabs/categories">
          <div class="icon-box pie-chart"><ion-icon name="pie-chart"></ion-icon></div>
          <span>Categories</span>
        </button>
      </section>

      <section class="card-section">
        <div class="section-header">
          <h2>Recent transactions</h2>
          <button class="see-all-btn" routerLink="/tabs/transactions">
             See All <ion-icon name="arrow-forward-outline"></ion-icon>
          </button>
        </div>
        <div class="transactions-horizontal-list">
          @for (tx of recentTransactions().slice(0, 5); track tx.id) {
            <div class="tx-card" (click)="editTransaction(tx)">
              <div class="tx-card-header">
                <div class="tx-card-icon" [ngClass]="getCategoryColorClass(tx.categoryId)">
                  <ion-icon [name]="getCategoryIcon(tx.categoryId)"></ion-icon>
                </div>
                <div class="tx-type-icon" [ngClass]="getTxTypeClass(tx)">
                  <ion-icon [name]="getTxTypeIcon(tx)"></ion-icon>
                </div>
              </div>
              <div class="tx-card-body">
                <span class="tx-name">{{ tx.merchantName || tx.description || getCategoryName(tx.categoryId) }}</span>
                <span class="tx-amount">{{ tx.amount | currency }}</span>
              </div>
            </div>
          } @empty {
            <div class="empty-state"><p>No recent transactions</p></div>
          }
        </div>
      </section>

      @if (accountService.accounts().length > 0 || detectedBanks().length > 0) {
        <section class="card-section accounts-section">
          <div class="section-header-simple">
            <div class="title-with-icon">
              <ion-icon name="card-outline"></ion-icon>
              <h2>Accounts</h2>
            </div>
            <ion-icon name="chevron-forward-outline" class="chevron"></ion-icon>
          </div>
          <div class="accounts-scroll">
            @for (acc of accountService.accounts(); track acc.id) {
              <div class="account-card" [ngClass]="getAccountTheme(acc.name)" [routerLink]="['/tabs/accounts', acc.id]">
                <div class="acc-top">
                  <div class="bank-logo"><ion-icon name="business-outline"></ion-icon></div>
                  <div class="acc-balance">
                    <span>{{ (accountSpends()[acc.id] || 0) | currency }} <ion-icon name="arrow-up-outline"></ion-icon></span>
                  </div>
                </div>
                <div class="acc-bottom">
                  <div class="acc-info">
                    <span class="bank-name">{{ acc.name }}</span>
                    <span class="bank-number">xx{{ acc.accountIdentifier?.slice(-4) || '0000' }}</span>
                  </div>
                  <div class="acc-status">
                     Tap to view details <ion-icon name="chevron-forward-outline" class="refresh"></ion-icon>
                  </div>
                </div>
              </div>
            }

            @for (bank of detectedBanks(); track bank.name) {
              <div class="account-card theme-gradient" style="border: 1px dashed rgba(255,255,255,0.4); opacity: 0.9;">
                <div class="acc-top" style="align-items: center;">
                  <div class="bank-logo" style="background: rgba(255,255,255,0.2);"><ion-icon name="business-outline"></ion-icon></div>
                  <button class="add-bank-btn-sm" (click)="addDetectedBank(bank.name)">
                    Add <ion-icon name="add-outline"></ion-icon>
                  </button>
                </div>
                <div class="acc-bottom" style="margin-top: 16px;">
                  <div class="acc-info">
                    <span class="bank-name">{{ bank.name }}</span>
                    <span class="bank-number" style="font-size: 11px;">
                      @if (bank.accIdentifier) { xx{{ bank.accIdentifier.slice(-4) }} } @else { Detected via SMS }
                    </span>
                  </div>
                  @if (bank.totalAmount > 0) {
                    <div class="acc-balance" style="font-size: 13px;">
                      <span>{{ bank.totalAmount | currency }} <ion-icon name="arrow-down-outline" style="color: #f44336; font-size: 10px;"></ion-icon></span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </section>
      }

      <section class="card-section splits-section">
        <div class="section-header-simple">
          <div class="title-with-icon">
            <ion-icon name="contract-outline" style="transform: rotate(45deg);"></ion-icon>
            <h2>Splits</h2>
          </div>
          <div class="actions">
            <ion-icon name="add-outline" class="action-icon add" (click)="showComingSoon()"></ion-icon>
            <ion-icon name="chevron-forward-outline" class="action-icon forward" (click)="showComingSoon()"></ion-icon>
          </div>
        </div>
        <div class="splits-content">
          <h3>Create group & split expenses</h3>
          <p>Split your bills for room rent, hotel, outings, movies.</p>
        </div>
      </section>

    }
  </div>
</ion-content>