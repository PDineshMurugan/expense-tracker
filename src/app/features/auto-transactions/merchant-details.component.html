<ion-content [fullscreen]="true" class="merchant-details-content">
  <!-- Simple Header overlapping background -->
  <div class="header-simple">
    <ion-buttons>
      <ion-back-button defaultHref="/tabs/auto-transactions" class="custom-back-btn"></ion-back-button>
    </ion-buttons>
    <h2>{{ merchantName() }}</h2>
    <div style="width: 48px;"></div>
  </div>

  <div class="page-container animate-fade-in">
    <!-- Summary Header -->
    <div class="summary-header">
      <div class="summary-icon">
        <ion-icon name="card-outline"></ion-icon>
      </div>
      <div class="summary-total">{{ totalAmount() | currency }}</div>
      <div class="summary-count">{{ transactions().length }} Transactions</div>
      
      <button class="bulk-edit-btn" (click)="openBulkEdit()">
        <ion-icon name="create-outline"></ion-icon> Edit All Categories
      </button>
    </div>

    <!-- Date Grouped Transactions -->
    <div class="transaction-timeline">
      @for (group of groupedTransactions(); track group.dateStr) {
        <div class="date-group">
          <div class="date-header">
            <span class="date-text">{{ group.dateStr }}</span>
          </div>
          
          <div class="transaction-list stagger-children">
            @for (txn of group.items; track txn.id) {
              <div class="glass-card transaction-row animate-fade-in-up">
                <div class="transaction-icon-wrap" [class.transfer]="txn.isTransfer">
                  <ion-icon [name]="getTxnIcon(txn)"></ion-icon>
                </div>
                
                <div class="transaction-info">
                  <span class="transaction-title">{{ txn.userCategoryLabel ?? (txn.isTransfer ? 'Transfer' : 'Expense') }}</span>
                  <span class="transaction-meta">{{ formatTime(txn.date) }}</span>
                </div>

                <div class="transaction-amount-wrap">
                  <span class="transaction-amount" [class.transfer]="txn.isTransfer">
                    {{ txn.isTransfer ? '' : '-' }}{{ txn.amount | currency }}
                  </span>
                  <button class="edit-btn" (click)="openSingleEdit(txn.id, txn)">
                    <ion-icon name="create-outline"></ion-icon>
                  </button>
                </div>
              </div>
              @if (txn.originalBody) {
                <div class="transaction-raw-sms animate-fade-in">
                  {{ txn.originalBody }}
                </div>
              }
            }
          </div>
        </div>
      }
      @if (groupedTransactions().length === 0) {
        <p class="empty-text">No transactions found.</p>
      }
    </div>
  </div>

  <!-- Category Edit Modal -->
  <ion-modal [isOpen]="isEditModalOpen()" [initialBreakpoint]="1" [breakpoints]="[0, 1]" (didDismiss)="closeEditModal()">
    <ng-template>
      <div class="modal-header">
        <div class="modal-title">{{ editMode() === 'bulk' ? 'Edit All' : 'Edit Transaction' }}</div>
        <button class="icon-btn" (click)="closeEditModal()"><ion-icon name="close-outline"></ion-icon></button>
      </div>
      <ion-content class="ion-padding bg-pattern">
        <div class="modal-body">
          <h3 class="category-title">Select Category</h3>
          
          <div class="category-grid">
            @for (cat of availableCategories; track cat.label) {
              <div class="category-pill" 
                   [class.category-pill--selected]="tempSelectedCategory() === cat.icon"
                   (click)="selectCategory(cat.icon, cat.label)">
                <div class="category-pill__icon"><ion-icon [name]="cat.icon"></ion-icon></div>
                <span class="category-pill__name">{{ cat.label }}</span>
              </div>
            }
            
            <!-- Transfer Option built-in -->
            <div class="category-pill" 
                 [class.category-pill--selected]="tempIsTransfer()"
                 (click)="selectTransfer()">
              <div class="category-pill__icon"><ion-icon name="swap-horizontal"></ion-icon></div>
              <span class="category-pill__name">Transfer</span>
            </div>
          </div>

          <button class="save-btn save-btn--ready mt-4" (click)="saveCategory()">
            <span class="save-btn__text">Save Changes</span>
          </button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>